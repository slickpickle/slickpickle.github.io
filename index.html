<!DOCTYPE html>
<html>
<head>
<title>Bird Migrations</title>
<meta content="width=device-width, initial-scale=1" name="viewport" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script><!-- jQuery base library needed -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script> 
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<link rel="stylesheet" href="bird.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
crossorigin=""></script>

</head>
<body>
    <div class="title mobile">Migration Tracker</div>
    <div id="mapContainer">
        <div id="legend"><img src="Legend.png" alt=""></div>
        <div id="map"></div>
        <div id="notableBox">
            <button class="button-Notables" role="button" onclick="LocalNotables()">local notables</button>
        </div>
        <div id="deschutesBox">
            <button class="button-Notables" role="button" onclick="desBirdsfnc()">deschutes birds</button>
        </div>
        <div id="crookBox">
            <button class="button-Notables" role="button" onclick="crookBirdsfnc()">crook birds</button>
        </div>
        <div id="nearMeBox">
            <button class="button-Notables" role="button" onclick="nearMefnc()">near me</button>
        </div>
    </div>
    <div id = "selectors">
        <div class="title desktop">Migration Tracker</div>
        <div class="container">
        <select class="js-example-basic-single selectOld" id="notableList" name="notableList" style="width: 95%" onChange="mapBirds(this.value)">
            <option value="" disabled selected>Notable birds...</option>
        </select>
        </div>

        <div class="container">
        <select class="js-example-basic-single selectOld" id="oregonList" name="oregonList" style="width: 95%" onChange="mapBirds(this.value)">
            <option value="" disabled selected>Oregon birds...</option>
        </select>
        </div>
        <div id="sliderContainer" class="sliderContainer">
            <input type="range" min="1" max="100" value="50" class="slider" id="dateRange">
        </div>
        <div id="dateContainer">
          <div id="date"></div>
        </div>
        <div id="countContainer">
          <div id="counts"></div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            $('.js-example-basic-single').select2();
        });

        var map = L.map('map').setView([40.8, -119.5], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
          subdomains: 'abcd',
          maxZoom: 20
        }).addTo(map);

        const apiKey = "g0gbj09j2s1b"; // replace with your own eBird API key      
        var enpointOregonRecent = "https://api.ebird.org/v2/data/obs/US-OR/recent"
        var enpointNotable = "https://api.ebird.org/v2/data/obs/US-OR/recent/notable?detail=simple"
        
        var notables = "off"
        var desBirds = "off"
        var crookBirds = "off"
        var nearMeBirds = "off"
        var lat
        var lng
        var notableData = []
        var uniqueNotable = []
        var oregonRecentData = []
        var uniqueOregon = []
        var fullList = []
        var birdData
        var layer = L.layerGroup()
        var layerMe = L.layerGroup()
        var layerMass = L.layerGroup()
        var dateObs = []
        var birdDate = document.getElementById("date");
        var siteCount
        var totalCount
        var symbology
        var symbType
        var notableBirdList = []
        var desBirdList = []
        var crookBirdList = []
        var nearMeBirdList = []
        var first = {
            color: '#d97357',
            opacity: 0.1,
            fillColor: '#d97357',
            fillOpacity: 0.1,
            radius: 10000
        }
        var second = {
            color: '#cc8529',
            opacity: 0.1,
            fillColor: '#cc8529',
            fillOpacity: 0.2,
            radius: 10000
        }
        var third = {
            color: '#c4c41a',
            opacity: 0.0,
            fillColor: '#c4c41a',
            fillOpacity: 0.3,
            radius: 10000
        }
        var fourth = {
            color: '#4acc0e',
            opacity: 0.0,
            fillColor: '#4acc0e',
            fillOpacity: 0.3,
            radius: 10000
        }
        var firstFarAway = {
            color: '#d97357',
            opacity: 0.6,
            fillColor: '#d97357',
            fillOpacity: 0.3,
            radius: 50000
        }
        var secondFarAway = {
            color: '#cc8529',
            opacity: 0.6,
            fillColor: '#cc8529',
            fillOpacity: 0.3,
            radius: 50000
        }
        var thirdFarAway = {
            color: '#c4c41a',
            opacity: 0.6,
            fillColor: '#c4c41a',
            fillOpacity: 0.3,
            radius: 50000
        }
        var fourthFarAway = {
            color: '#4acc0e',
            opacity: 0.6,
            fillColor: '#4acc0e',
            fillOpacity: 0.3,
            radius: 50000
        }





        fetch(enpointOregonRecent, {
        headers: {
            "X-eBirdApiToken": apiKey,
            },
        })
        .then(response => response.json())
        .then(data => {
            data.forEach(observation => {
                var OrRecObj = {
                "comName": observation.comName,
                "speciesCode": observation.speciesCode
            }
            oregonRecentData.push(OrRecObj)
            fullList.push(OrRecObj) 
            });
            var uniqueOregon = [...new Set(oregonRecentData.map(item => item.comName))];
            uniqueOregon.sort();             

            var dataList = document.getElementById('oregonList'); 
            for(var i = 0; i < uniqueOregon.length; i++) {
            var opt = uniqueOregon[i];
            var el = document.createElement("option");
            el.text = opt;
            el.value = opt;
            dataList.appendChild(el);
            }
        })
            

        fetch(enpointNotable, {
            headers: {
            "X-eBirdApiToken": apiKey,
            },
        })
        .then(response => response.json())
        .then(data => {
            data.forEach(observation => {
            var notableObj = {
                "comName": observation.comName,
                "speciesCode": observation.speciesCode
            }
            notableData.push(notableObj)
            fullList.push(notableObj) 
            });
            var uniqueNotable = [...new Set(notableData.map(item => item.comName))];
            uniqueNotable.sort();             

            var dataList = document.getElementById('notableList'); 
            for(var i = 0; i < uniqueNotable.length; i++) {
            var opt = uniqueNotable[i];
            var el = document.createElement("option");
            el.text = opt;
            el.value = opt;
            dataList.appendChild(el);
            }
        })



        function mapBirds(comName) {
            layerMe.clearLayers()
            document.getElementById("sliderContainer").style.display = "block";
            siteCount = 0
            totalCount = 0
            symbType = ''
            notables = 'off'
            desBirds = 'off'
            crookBirds = 'off'
            birdDate.textContent = "Last 30 Days";
            var fg = L.featureGroup();
            var specCode
            fullList.forEach(type => {
                if (comName == type.comName) {
                    specCode = type.speciesCode
                }
            })
            fetch(`https://api.ebird.org/v2/data/obs/US-OR/recent/${specCode}?back=30&r=US-ID,US-CA,US-NV,US-WA,US-OR`, {
            headers: {
            "X-eBirdApiToken": apiKey,
            },
            })
            .then(response => response.json())
            .then(data => {
                data.sort((a, b) => a.obsDt.localeCompare(b.obsDt));
                birdData = data
                layer.clearLayers()
                data.forEach(observation => {
                    if (observation.howMany) {
                        totalCount = totalCount + observation.howMany
                    }
                    siteCount = siteCount + 1
                    var currDateParts = observation.obsDt.substring(0,10).split('-')
                    var currDate = Number(currDateParts[0]+currDateParts[1]+currDateParts[2])
                    observation.obsDt = currDate
                });

                if (data.length > 0) {   
                    data.forEach(observation => {
                        dateObs.push(observation.obsDt)
                    })

                    datesObjArr = []
                    dateArr = []
                    dateSet = new Set(dateObs)

                    dateSet.forEach(date =>{
                        dateArr.push(date)
                    })

                    dateArr.sort()

                    var d =0

                    dateArr.forEach(date => {
                        d=d+1
                        var dateObj = {
                            "id": d,
                            "dateInt": date,
                            "dateTxt": date.toString().slice(4,6)+"/"+date.toString().slice(6,8)+"/"+date.toString().slice(0,4)
                        }
                        datesObjArr.push(dateObj)
            
                    })
                    
                    var monthQuarters = Math.max(...datesObjArr.map(o => o.id))/4

                    data.forEach(observation => {
                        var dtObj = datesObjArr.filter(function (el) {
                            return el.dateInt == observation.obsDt
                        });

                        observation.dateIndex = dtObj[0].id

                        if (observation.dateIndex < monthQuarters) {
                            symbology = first
                        } else if (observation.dateIndex >= monthQuarters && observation.dateIndex < monthQuarters*2) {
                            symbology = second
                        } else if (observation.dateIndex >= monthQuarters*2 && observation.dateIndex < monthQuarters*3) {
                            symbology = third
                        } else {
                            symbology = fourth
                        }

                        L.circle([observation.lat, observation.lng], symbology).bindPopup("Date: "+observation.obsDt.toString().slice(4,6)+"/"+observation.obsDt.toString().slice(6,8)+"/"+observation.obsDt.toString().slice(0,4)+`</br>Location: `+observation.locName+`</br>Bird Info: <a target='_blank' href='https://ebird.org/species/${specCode}'>More Info</a>`).addTo(layer);
                        L.marker([observation.lat, observation.lng]).addTo(fg)
                    })
                    layer.addTo(map)
                    map.fitBounds(fg.getBounds(), {maxZoom: 9});

                    document.getElementById("dateRange").max = datesObjArr.length;
                    document.getElementById("dateRange").min = 1;
                    document.getElementById("dateRange").value = datesObjArr.length;
                    document.getElementById("counts").textContent = `Site Count: ${siteCount.toLocaleString()} | Total Count: ${totalCount.toLocaleString()}`
                    document.getElementById("legend").style.display = "block";
                } else {
                    farAwayMap(specCode)
                }

            })

        }

        function farAwayMap(speciesCode) {
            siteCount = 0
            symbType = "farAway"
            totalCount = 0
            var fg = L.featureGroup();
            fetch(`https://api.ebird.org/v2/data/nearest/geo/recent/${speciesCode}?lat=44.3&lng=-121.2&back=30`, {
            headers: {
                "X-eBirdApiToken": apiKey,
                },
            })
            .then(response => response.json())
            .then(data => {
                birdData = data
                if (data.length > 0) {

                    data.sort((a, b) => a.obsDt.localeCompare(b.obsDt));
                    layer.clearLayers()
                    data.forEach(observation => {
                        if (observation.howMany) {
                            totalCount = totalCount + observation.howMany
                        }
                        siteCount = siteCount + 1
                        var currDateParts = observation.obsDt.substring(0,10).split('-')
                        var currDate = Number(currDateParts[0]+currDateParts[1]+currDateParts[2])
                        observation.obsDt = currDate
                    }); 
                                
                    data.forEach(observation => {
                        dateObs.push(observation.obsDt)
                    })

                    datesObjArr = []
                    dateArr = []
                    dateSet = new Set(dateObs)

                    dateSet.forEach(date =>{
                        dateArr.push(date)
                    })

                    dateArr.sort()

                    var d =0

                    dateArr.forEach(date => {
                        d=d+1
                        var dateObj = {
                            "id": d,
                            "dateInt": date,
                            "dateTxt": date.toString().slice(4,6)+"/"+date.toString().slice(6,8)+"/"+date.toString().slice(0,4)
                        }
                        datesObjArr.push(dateObj)
        
                    })
                    
                    var monthQuarters = Math.max(...datesObjArr.map(o => o.id))/4

                    data.forEach(observation => {
                        var dtObj = datesObjArr.filter(function (el) {
                            return el.dateInt == observation.obsDt
                        });

                        observation.dateIndex = dtObj[0].id

                        if (observation.dateIndex < monthQuarters) {
                            symbology = firstFarAway
                        } else if (observation.dateIndex >= monthQuarters && observation.dateIndex < monthQuarters*2) {
                            symbology = secondFarAway
                        } else if (observation.dateIndex >= monthQuarters*2 && observation.dateIndex < monthQuarters*3) {
                            symbology = thirdFarAway
                        } else {
                            symbology = fourthFarAway
                        }

                        L.circle([observation.lat, observation.lng], symbology).bindPopup("Date: "+observation.obsDt.toString().slice(4,6)+"/"+observation.obsDt.toString().slice(6,8)+"/"+observation.obsDt.toString().slice(0,4)+`</br>Location: `+observation.locName+`</br>Bird Info: <a target='_blank' href='https://ebird.org/species/${speciesCode}'>More Info</a>`).addTo(layer);
                        L.marker([observation.lat, observation.lng]).addTo(fg, {maxZoom: 9})
                    })
                    layer.addTo(map)
                    map.fitBounds(fg.getBounds());



                    document.getElementById("dateRange").max = datesObjArr.length;
                    document.getElementById("dateRange").min = 1;
                    document.getElementById("dateRange").value = 30;
                    birdDate.textContent = "No sightings on West Coast. Closest in last 30 Days";
                    document.getElementById("counts").textContent = `Site Count: ${siteCount.toLocaleString()} | Total Count: ${totalCount.toLocaleString()}`
                    document.getElementById("legend").style.display = "block";
                } else {
                    document.getElementById("legend").style.display = "none";          
                    birdDate.textContent = "No birds reported in last 30 days";
                    document.getElementById("counts").textContent = ''
                }
                
            })
        }


        var slider = document.getElementById("dateRange");
        slider.oninput = function() {
            layer.clearLayers()
            var tempDateInt
            var tempDateTxt
            datesObjArr.forEach(date => {
            if (slider.value == date.id){
                tempDateInt = date.dateInt
                tempDateTxt = date.dateTxt
            }
            })
            if (symbType == "marker"){
                var bbd = birdData.filter(function (el){
                return el.obsDt <= tempDateInt
                })
                bbd.forEach(observation => {
                            L.marker([observation.lat, observation.lng]).bindPopup("Species: "+observation.comName+"<br>Date: "+observation.obsDt.toString().slice(4,6)+"/"+observation.obsDt.toString().slice(6,8)+"/"+observation.obsDt.toString().slice(0,4)+`</br>Location: `+observation.locName+`</br>Bird Info: <a target='_blank' href='https://ebird.org/species/` + observation.speciesCode +`'>More Info</a>`).addTo(layer);
                        })
                        layer.addTo(map)
            } else if (symbType == "farAway") {
                var bbd = birdData.filter(function (el){
                return el.obsDt <= tempDateInt
                })
                if(bbd.length > 0) {
                    var monthQuarters = Math.max(...datesObjArr.map(o => o.id))/4
                    birdDate.textContent = tempDateTxt;

                    bbd.forEach(observation => {
                        if (observation.dateIndex < monthQuarters) {
                            symbology = firstFarAway
                        } else if (observation.dateIndex >= monthQuarters && observation.dateIndex < monthQuarters*2) {
                            symbology = secondFarAway
                        } else if (observation.dateIndex >= monthQuarters*2 && observation.dateIndex < monthQuarters*3) {
                            symbology = thirdFarAway
                        } else {
                            symbology = fourthFarAway
                        }
                        L.circle([observation.lat, observation.lng], symbology).bindPopup("Date: "+observation.obsDt.toString().slice(4,6)+"/"+observation.obsDt.toString().slice(6,8)+"/"+observation.obsDt.toString().slice(0,4)+`</br>Location: `+observation.locName+`</br>Bird Info: <a target='_blank' href='https://ebird.org/species/${observation.speciesCode}'>More Info</a>`).addTo(layer);

                    })
                    layer.addTo(map)
                } 
            } else {
                var bbd = birdData.filter(function (el){
                    return el.obsDt <= tempDateInt
                })
                if(bbd.length > 0) {
                    var monthQuarters = Math.max(...datesObjArr.map(o => o.id))/4
                    birdDate.textContent = tempDateTxt;
                    bbdLat =[]
                    bbdLng = []
                    var latMean
                    var lngMean
                    bbd.forEach(observation => {
                        bbdLat.push(observation.lat)
                        bbdLng.push(observation.lng)

                        if (observation.dateIndex < monthQuarters) {
                            symbology = first
                        } else if (observation.dateIndex >= monthQuarters && observation.dateIndex < monthQuarters*2) {
                            symbology = second
                        } else if (observation.dateIndex >= monthQuarters*2 && observation.dateIndex < monthQuarters*3) {
                            symbology = third
                        } else {
                            symbology = fourth
                        }
                        L.circle([observation.lat, observation.lng], symbology).bindPopup("Date: "+observation.obsDt.toString().slice(4,6)+"/"+observation.obsDt.toString().slice(6,8)+"/"+observation.obsDt.toString().slice(0,4)+`</br>Location: `+observation.locName+`</br>Bird Info: <a target='_blank' href='https://ebird.org/species/${observation.speciesCode}'>More Info</a>`).addTo(layer);

                    })
                    var totalLat = 0;
                    var totalLng = 0;
                    for(var i = 0; i < bbdLat.length; i++) {
                        totalLat += bbdLat[i];
                        totalLng += bbdLng[i];
                    }
                    latMean = totalLat / bbdLat.length;
                    lngMean = totalLng / bbdLng.length;



                    layerMass.clearLayers()
                    L.circle([latMean, lngMean], {
                        color: 'black',
                        opacity: 0.0,
                        fillColor: 'black',
                        fillOpacity: .2,
                        radius: 100000
                    }).addTo(layerMass)

                    layerMass.addTo(map)
                    layer.addTo(map)
                } 
            } 
        }


        function LocalNotables() {
            layerMe.clearLayers()
            document.getElementById("sliderContainer").style.display = "block";
            if (notables == "off") {
                document.getElementById("legend").style.display = "none";
                document.getElementById("counts").textContent = ''
                datesObjArr = []
                dateObs = []
                notables = "on"
                desBirds = 'off'
                crookBirds = 'off'
                nearMeBrids = 'off'
                symbType = 'marker'
                birdDate.textContent = "Last 30 Days";
                var fg = L.featureGroup();
                fetch(`https://api.ebird.org/v2/data/obs/US-OR-013/recent/notable?back=30&r=US-OR-013,US-OR-031,US-OR-017`, {
                headers: {
                "X-eBirdApiToken": apiKey,
                },
                })
                .then(response => response.json())
                .then(data => {
                    data.sort((a, b) => a.obsDt.localeCompare(b.obsDt));
                    birdData = data
                    layer.clearLayers()
                    data.forEach(observation => {
                        var currDateParts = observation.obsDt.substring(0,10).split('-')
                        var currDate = Number(currDateParts[0]+currDateParts[1]+currDateParts[2])
                        observation.obsDt = currDate
                    });

                    if (data.length > 0) {
                        data.forEach(observation => {
                            notableBirdList.push(observation.comName)  
                            dateObs.push(observation.obsDt)
                        })
                        var birdListSet = new Set(notableBirdList)
                        notableBirdList = []
                        birdListSet.forEach(bird =>{
                            notableBirdList.push(bird)
                        })
                        notableBirdList.sort()
                        notableBirdList.forEach(bird => {
                            var countDiv = document.getElementById("counts");
                            var buttonDiv = document.createElement('div');
                            buttonDiv.setAttribute('class',"notableListButton")
                            var aTag = document.createElement('a');
                            aTag.setAttribute('href',"#");
                            aTag.setAttribute('onclick',"mapNotableSingle(`" + bird + "`)");
                            buttonDiv.innerText = bird;
                            countDiv.appendChild(aTag);
                            aTag.appendChild(buttonDiv)
                        })
                        
                        dateArr = []
                        dateSet = new Set(dateObs)
                        dateSet.forEach(date =>{
                            dateArr.push(date)
                        })
                        dateArr.sort()
                        var d =0
                        dateArr.forEach(date => {
                            d=d+1
                            var dateObj = {
                                "id": d,
                                "dateInt": date,
                                "dateTxt": date.toString().slice(4,6)+"/"+date.toString().slice(6,8)+"/"+date.toString().slice(0,4)
                            }
                            datesObjArr.push(dateObj)
                        })

                        data.forEach(observation => {
                            L.marker([observation.lat, observation.lng]).bindPopup("Species: "+observation.comName+"<br>Date: "+observation.obsDt.toString().slice(4,6)+"/"+observation.obsDt.toString().slice(6,8)+"/"+observation.obsDt.toString().slice(0,4)+`</br>Location: `+observation.locName+`</br>Bird Info: <a target='_blank' href='https://ebird.org/species/` + observation.speciesCode +`'>More Info</a>`).addTo(layer);
                            L.marker([observation.lat, observation.lng]).addTo(fg)
                        })
                        layer.addTo(map)
                        map.fitBounds(fg.getBounds());
                        document.getElementById("dateRange").max = datesObjArr.length;
                        document.getElementById("dateRange").min = 1;
                        document.getElementById("dateRange").value = datesObjArr.length;
                    } else {
                        console.log("no data")
                    }

                })

            } else {
                notables = "off"
                layer.clearLayers()
                map.setView([40.8, -119.5], 4)
                document.getElementById("counts").textContent = ''
            }
        }

        function mapNotableSingle(bird) {
            layer.clearLayers()
            var fg = L.featureGroup();
            birdData.forEach(observation => {
              if (observation.comName == bird) {
                L.marker([observation.lat, observation.lng]).addTo(fg)
                L.marker([observation.lat, observation.lng]).bindPopup("Species: "+observation.comName+"<br>Date: "+observation.obsDt.toString().slice(4,6)+"/"+observation.obsDt.toString().slice(6,8)+"/"+observation.obsDt.toString().slice(0,4)+`</br>Location: `+observation.locName+`</br>Bird Info: <a target='_blank' href='https://ebird.org/species/` + observation.speciesCode +`'>More Info</a>`).addTo(layer);
              }
            })
            map.fitBounds(fg.getBounds(), {maxZoom: 14});
        }

        function crookBirdsfnc() {
            document.getElementById("sliderContainer").style.display = "none";
            layerMe.clearLayers()
            if (crookBirds == "off") {
                map.setView([44.1526, -120.3889], 9)
                document.getElementById("legend").style.display = "none";
                document.getElementById("counts").textContent = ''
                crookBirds = "on"
                desBirds = 'off'
                notables = 'off'
                symbType = 'marker'
                dateObs = []
                birdDate.textContent = "Last 30 Days";
                var fg = L.featureGroup();
                fetch("https://api.ebird.org/v2/data/obs/US-OR-013/recent?back=30", {
                headers: {
                "X-eBirdApiToken": apiKey,
                },
                })
                .then(response => response.json())
                .then(data => {
                    data.sort((a, b) => a.obsDt.localeCompare(b.obsDt));
                    layer.clearLayers()
                    data.forEach(observation => {
                        crookBirdList.push(observation.comName)  
                        var birdListSet = new Set(crookBirdList)
                        crookBirdList = []
                        birdListSet.forEach(bird =>{
                            crookBirdList.push(bird)
                        })
                        crookBirdList.sort()
                        
                    })
                    crookBirdList.forEach(bird => {

                        var countDiv = document.getElementById("counts");
                        var buttonDiv = document.createElement('div');
                        buttonDiv.setAttribute('class',"notableListButton")
                        var aTag = document.createElement('a');
                        aTag.setAttribute('href',"#");
                        aTag.setAttribute('onclick',"mapCrookSingle(`" + bird + "`)");
                        buttonDiv.innerText = bird;
                        countDiv.appendChild(aTag);
                        aTag.appendChild(buttonDiv)

                    })

                })

            } else {
                crookBirds = "off"
                layer.clearLayers()
                map.setView([40.8, -119.5], 4)
                document.getElementById("counts").textContent = ''
            }
        }

        function mapCrookSingle(bird) {
            layer.clearLayers()
            var fg = L.featureGroup();
            fullList.forEach(type => {
                if (bird == type.comName) {
                    specCode = type.speciesCode
                }
            })
            fetch(`https://api.ebird.org/v2/data/obs/US-OR-013/recent/${specCode}?back=30`, {
                headers: {
                    "X-eBirdApiToken": apiKey,
                },
            })
            .then(response => response.json())
            .then(data => {
                data.forEach(observation => {
                    var currDateParts = observation.obsDt.substring(0,10).split('-')
                    var currDate = Number(currDateParts[0]+currDateParts[1]+currDateParts[2])
                    observation.obsDt = currDate
                    L.marker([observation.lat, observation.lng]).bindPopup("Species: "+observation.comName+"<br>Date: "+observation.obsDt.toString().slice(4,6)+"/"+observation.obsDt.toString().slice(6,8)+"/"+observation.obsDt.toString().slice(0,4)+`</br>Location: `+observation.locName+`</br>Bird Info: <a target='_blank' href='https://ebird.org/species/` + observation.speciesCode +`'>More Info</a>`).addTo(layer);
                    L.marker([observation.lat, observation.lng]).addTo(fg)

                });

                layer.addTo(map)
                map.fitBounds(fg.getBounds(), {maxZoom: 14});
            
            })
            
        }

        function desBirdsfnc() {
            layerMe.clearLayers()
            document.getElementById("sliderContainer").style.display = "none";
            if (desBirds == "off") {
                map.setView([44.001911, -121.5098826], 9)
                document.getElementById("legend").style.display = "none";
                document.getElementById("counts").textContent = ''
                crookBirds = "off"
                desBirds = 'on'
                notables = 'off'
                symbType = 'marker'
                birdDate.textContent = "Last 30 Days";
                var fg = L.featureGroup();
                fetch("https://api.ebird.org/v2/data/obs/US-OR-017/recent?back=30", {
                headers: {
                "X-eBirdApiToken": apiKey,
                },
                })
                .then(response => response.json())
                .then(data => {
                    data.sort((a, b) => a.obsDt.localeCompare(b.obsDt));
                    layer.clearLayers()
                    data.forEach(observation => {
                        desBirdList.push(observation.comName)  
                        var birdListSet = new Set(desBirdList)
                        desBirdList = []
                        birdListSet.forEach(bird =>{
                            desBirdList.push(bird)
                        })
                        desBirdList.sort()
                        
                    })
                    desBirdList.forEach(bird => {

                        var countDiv = document.getElementById("counts");
                        var buttonDiv = document.createElement('div');
                        buttonDiv.setAttribute('class',"notableListButton")
                        var aTag = document.createElement('a');
                        aTag.setAttribute('href',"#");
                        aTag.setAttribute('onclick',"mapDesSingle(`" + bird + "`)");
                        buttonDiv.innerText = bird;
                        countDiv.appendChild(aTag);
                        aTag.appendChild(buttonDiv)

                    })

                })

            } else {
                desBirds = "off"
                layer.clearLayers()
                map.setView([40.8, -119.5], 4)
                document.getElementById("counts").textContent = ''
            }
        }

        function mapDesSingle(bird) {
            layer.clearLayers()
            var fg = L.featureGroup();
            fullList.forEach(type => {
                if (bird == type.comName) {
                    specCode = type.speciesCode
                }
            })
            fetch(`https://api.ebird.org/v2/data/obs/US-OR-017/recent/${specCode}?back=30`, {
                        headers: {
                        "X-eBirdApiToken": apiKey,
                        },
                        })
                        .then(response => response.json())
                        .then(data => {
                            data.forEach(observation => {
                                var currDateParts = observation.obsDt.substring(0,10).split('-')
                                var currDate = Number(currDateParts[0]+currDateParts[1]+currDateParts[2])
                                observation.obsDt = currDate
                                L.marker([observation.lat, observation.lng]).bindPopup("Species: "+observation.comName+"<br>Date: "+observation.obsDt.toString().slice(4,6)+"/"+observation.obsDt.toString().slice(6,8)+"/"+observation.obsDt.toString().slice(0,4)+`</br>Location: `+observation.locName+`</br>Bird Info: <a target='_blank' href='https://ebird.org/species/` + observation.speciesCode +`'>More Info</a>`).addTo(layer);
                                L.marker([observation.lat, observation.lng]).addTo(fg)

                            });

                            layer.addTo(map)
                            map.fitBounds(fg.getBounds(), {maxZoom: 14});
                        
                        })
            
        }

        function nearMefnc() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            } else {
                console.log("Geolocation is not supported by this browser.")
            }
        }

        function showPosition(position) {
            lat = position.coords.latitude
            lng = position.coords.longitude
            layerMe.clearLayers()
            var fg = L.featureGroup();
            L.circle([lat, lng], {
                color: 'green',
                opacity: 1.0,
                fillColor: 'green',
                fillOpacity: 0.3,
                radius: 500
            }).addTo(layerMe)
            L.circle([lat, lng], {
                color: 'black',
                opacity: 1.0,
                fillColor: 'black',
                fillOpacity: 1.0,
                radius: 50
            }).addTo(layerMe)
            layerMe.addTo(map)

            document.getElementById("sliderContainer").style.display = "block";
            if (nearMeBirds == "off") {
                document.getElementById("legend").style.display = "none";
                document.getElementById("counts").textContent = ''
                datesObjArr = []
                dateObs = []
                nearMeBirds = "on"
                notables = "off"
                desBirds = 'off'
                crookBirds = 'off'
                symbType = 'marker'
                birdDate.textContent = "Last 30 Days";

                fetch(`https://api.ebird.org/v2/data/obs/geo/recent?lat=${lat}&lng=${lng}&back=30&dist=20`, {
                        headers: {
                        "X-eBirdApiToken": apiKey,
                        },
                        })
                        .then(response => response.json())
                        .then(data => {
                    data.sort((a, b) => a.obsDt.localeCompare(b.obsDt));
                    birdData = data
                    layer.clearLayers()
                    data.forEach(observation => {
                        var currDateParts = observation.obsDt.substring(0,10).split('-')
                        var currDate = Number(currDateParts[0]+currDateParts[1]+currDateParts[2])
                        observation.obsDt = currDate
                    });

                    if (data.length > 0) {
                        data.forEach(observation => {
                            notableBirdList.push(observation.comName)  
                            dateObs.push(observation.obsDt)
                        })
                        var birdListSet = new Set(notableBirdList)
                        notableBirdList = []
                        birdListSet.forEach(bird =>{
                            notableBirdList.push(bird)
                        })
                        notableBirdList.sort()
                        notableBirdList.forEach(bird => {
                            var countDiv = document.getElementById("counts");
                            var buttonDiv = document.createElement('div');
                            buttonDiv.setAttribute('class',"notableListButton")
                            var aTag = document.createElement('a');
                            aTag.setAttribute('href',"#");
                            aTag.setAttribute('onclick',"mapNearMeSingle(`" + bird + "`)");
                            buttonDiv.innerText = bird;
                            countDiv.appendChild(aTag);
                            aTag.appendChild(buttonDiv)
                        })
                        
                        dateArr = []
                        dateSet = new Set(dateObs)

                        dateSet.forEach(date =>{
                            dateArr.push(date)
                        })

                        dateArr.sort()

                        var d =0

                        dateArr.forEach(date => {
                            d=d+1
                            var dateObj = {
                                "id": d,
                                "dateInt": date,
                                "dateTxt": date.toString().slice(4,6)+"/"+date.toString().slice(6,8)+"/"+date.toString().slice(0,4)
                            }
                            datesObjArr.push(dateObj)
            
                        })

                        data.forEach(observation => {
                            L.marker([observation.lat, observation.lng]).bindPopup("Species: "+observation.comName+"<br>Date: "+observation.obsDt.toString().slice(4,6)+"/"+observation.obsDt.toString().slice(6,8)+"/"+observation.obsDt.toString().slice(0,4)+`</br>Location: `+observation.locName+`</br>Bird Info: <a target='_blank' href='https://ebird.org/species/` + observation.speciesCode +`'>More Info</a>`).addTo(layer);
                            L.marker([observation.lat, observation.lng]).addTo(fg)
                        })
                        layer.addTo(map)
                        map.fitBounds(fg.getBounds());
                        document.getElementById("dateRange").max = datesObjArr.length;
                        document.getElementById("dateRange").min = 1;
                        document.getElementById("dateRange").value = datesObjArr.length;
                    } else {
                        console.log("no data")
                    }

                })

            } else {
                nearMeBirds = "off"
                layer.clearLayers()
                map.setView([40.8, -119.5], 4)
                document.getElementById("counts").textContent = ''
            }
        }

        function mapNearMeSingle(bird) {
            layer.clearLayers()
            var fg = L.featureGroup();
            fullList.forEach(type => {
                if (bird == type.comName) {
                    specCode = type.speciesCode
                }
            })
            fetch(`https://api.ebird.org/v2/data/obs/geo/recent/${specCode}?lat=${lat}&lng=${lng}&back=30&dist=20`, {
                        headers: {
                        "X-eBirdApiToken": apiKey,
                        },
                        })
                        .then(response => response.json())
                        .then(data => {
                            data.forEach(observation => {
                                var currDateParts = observation.obsDt.substring(0,10).split('-')
                                var currDate = Number(currDateParts[0]+currDateParts[1]+currDateParts[2])
                                observation.obsDt = currDate
                                L.marker([observation.lat, observation.lng]).bindPopup("Species: "+observation.comName+"<br>Date: "+observation.obsDt.toString().slice(4,6)+"/"+observation.obsDt.toString().slice(6,8)+"/"+observation.obsDt.toString().slice(0,4)+`</br>Location: `+observation.locName+`</br>Bird Info: <a target='_blank' href='https://ebird.org/species/` + observation.speciesCode +`'>More Info</a>`).addTo(layer);
                                L.marker([observation.lat, observation.lng]).addTo(fg)

                            });

                            layer.addTo(map)
                            map.fitBounds(fg.getBounds(), {maxZoom: 14});
                        
                        })
        }
    </script>
</body>
</html>
