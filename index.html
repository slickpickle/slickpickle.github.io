<!DOCTYPE html>
<html>
  <head>
    <title>Bird Migrations</title>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
    crossorigin=""/>
    <style>
        body{
                padding: 0;
                margin: 0;
        }
        .title {
            text-align: center;
            text-align: center;
            font-family: -apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
            font-size: 24px;
            font-weight: 500;
            margin: 10px;
        }
        @media (min-width: 767px) {
            .mobile {
                display: none;
            }
            #map {
                width: 70%;
                height: 100vh;
                float: left;
                border-radius: 12px;
            }
            #selectors {
                width: 30%;
                height: 100vh;
                float: left;
            }
            select {
                width: 90%;
                margin-left: 5%;
                padding: 16px 20px;
                border: none;
                border-radius: 4px;
                background-color: #f1f1f1;
                margin-top:10px;
            }
            input {
                width: 80%;
                margin-left: 5%;
                padding: 16px 20px;
                border: none;
                border-radius: 4px;
                background-color: #f1f1f1;
                margin-top:10px;
            }
            #dateContainer{
                text-align: center;
                font-family: -apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
                font-size: 12px;
                font-weight: 500;
            }
        }
        @media (max-width: 766px) {
            .desktop {
                display: none;
            }
            #map {
                width: 100vw;
                height: 60vh;
                float: left;
                border-radius: 12px;
            }
            #selectors {
                width: 100vw;
                height: 40vh;
                float: left;
            }
            select {
                width: 90%;
                margin-left: 5%;
                padding: 16px 20px;
                border: none;
                border-radius: 4px;
                background-color: #f1f1f1;
                margin-top:10px;
            }
            input {
                width: 80%;
                margin-left: 5%;
                padding: 16px 20px;
                border: none;
                border-radius: 4px;
                background-color: #f1f1f1;
                margin-top:10px;
            }
            #dateContainer{
                text-align: center;
                font-family: -apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
                font-size: 12px;
                font-weight: 500;
            }
        }

    </style>    
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
    crossorigin=""></script>

  </head>
  <body>
    <div class="title mobile">Migration Tracker</div>
    <h3 class="mobile"></h3>
    <div id="map"></div>
    <div class="title desktop">Migration Tracker</div>
    <div id = "selectors">
        <form>
            <select id="notableList" name="notableList" onChange="mapBirds(this.value)">
            <option value="" disabled selected>Notable birds...</option>
            </select>
        </form>
        <div class="container">
            <div class="text-container">
                <input type="text" list="oregonList" placeholder="Birds in Oregon..." onChange="mapBirds(this.value)" />
                <datalist id="oregonList"></datalist>
            </div>
        </div>
        <div class="slidecontainer">
            <input type="range" min="1" max="100" value="50" class="slider" id="dateRange">
        </div>
        <div id="dateContainer"><div id="date"></div></div>
    </div>
    
    <script>
      
        var map = L.map('map').setView([40.8, -119.5], 4);
        L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}{r}.{ext}', {
            attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            subdomains: 'abcd',
            minZoom: 0,
            maxZoom: 20,
            ext: 'png'
        }).addTo(map);

        const apiKey = "g0gbj09j2s1b"; // replace with your own eBird API key      
        var enpointOregonRecent = "https://api.ebird.org/v2/data/obs/US-OR/recent"
        var enpointNotable = "https://api.ebird.org/v2/data/obs/US-OR/recent/notable?detail=simple"
        
        var notableData = []
        var uniqueNotable = []
        var oregonRecentData = []
        var uniqueOregon = []
        var fullList = []
        var birdData
        var layer = L.layerGroup()
        var dateObs = []
        var birdDate = document.getElementById("date");

        fetch(enpointOregonRecent, {
        headers: {
            "X-eBirdApiToken": apiKey,
            },
        })
        .then(response => response.json())
        .then(data => {
            data.forEach(observation => {
                var OrRecObj = {
                "comName": observation.comName,
                "speciesCode": observation.speciesCode
            }
            oregonRecentData.push(OrRecObj)
            fullList.push(OrRecObj) 
            });
            var uniqueOregon = [...new Set(oregonRecentData.map(item => item.comName))];
            uniqueOregon.sort();             

            var dataList = document.getElementById('oregonList'); 
            for(var i = 0; i < uniqueOregon.length; i++) {
            var opt = uniqueOregon[i];
            var el = document.createElement("option");
            el.text = opt;
            el.value = opt;
            dataList.appendChild(el);
            }
        })
            

        fetch(enpointNotable, {
            headers: {
            "X-eBirdApiToken": apiKey,
            },
        })
        .then(response => response.json())
        .then(data => {
            data.forEach(observation => {
            var notableObj = {
                "comName": observation.comName,
                "speciesCode": observation.speciesCode
            }
            notableData.push(notableObj)
            fullList.push(notableObj) 
            });
            var uniqueNotable = [...new Set(notableData.map(item => item.comName))];
            uniqueNotable.sort();             

            var dataList = document.getElementById('notableList'); 
            for(var i = 0; i < uniqueNotable.length; i++) {
            var opt = uniqueNotable[i];
            var el = document.createElement("option");
            el.text = opt;
            el.value = opt;
            dataList.appendChild(el);
            }
        })



        function mapBirds(comName) {
            birdDate.textContent = "Last 30 Days";
            var fg = L.featureGroup();
            var specCode
            fullList.forEach(type => {
            if (comName == type.comName) {
                specCode = type.speciesCode
            }
            })
            fetch(`https://api.ebird.org/v2/data/obs/US-OR/recent/${specCode}?back=30&r=US-ID,US-CA,US-NV,US-WA,US-OR`, {
            headers: {
            "X-eBirdApiToken": apiKey,
            },
            })
            .then(response => response.json())
            .then(data => {
                birdData = data
                layer.clearLayers()
                data.forEach(observation => {
                    var currDateParts = observation.obsDt.substring(0,10).split('-')
                    var currDate = Number(currDateParts[0]+currDateParts[1]+currDateParts[2])
                    observation.obsDt = currDate
                });
                
                if (data.length > 1) {                
                    data.forEach(observation => {
                    L.circle([observation.lat, observation.lng], {
                        color: 'red',
                        opacity: 0.1,
                        fillColor: '#f03',
                        fillOpacity: 0.3,
                        radius: 10000
                    }).addTo(layer);
                    L.marker([observation.lat, observation.lng]).addTo(fg)
                    })
                    layer.addTo(map)
                    map.fitBounds(fg.getBounds());

                    datesObjArr = []
                    dateArr = []

                    data.forEach(observation => {
                    dateObs.push(observation.obsDt)
                    });
                    dateSet = new Set(dateObs)
                    dateSet.forEach(date =>{
                    dateArr.push(date)
                    })
                    dateArr.sort()
                    //For each date it captures the bird data in the data object, then pushes those into a layer group

                    var d =0
                    dateArr.forEach(date => {
                    d=d+1
                    var dateObj = {
                        "id": d,
                        "dateInt": date,
                        "dateTxt": date.toString().slice(4,6)+"/"+date.toString().slice(6,8)+"/"+date.toString().slice(0,4)
                    }
                    datesObjArr.push(dateObj)

                    // birdByDay = birdData.filter(function (el) {
                    //   return el.obsDt === date
                    // });            
                    })
                    document.getElementById("dateRange").max = datesObjArr.length;
                    document.getElementById("dateRange").min = 1;
                    document.getElementById("dateRange").value = 30;
                    

                } else {
                    farAwayMap(specCode)
                }

            })

        }

        function farAwayMap(speciesCode) {
            var fg = L.featureGroup();
            fetch(`https://api.ebird.org/v2/data/nearest/geo/recent/${speciesCode}?lat=44.3&lng=-121.2&back=30`, {
            headers: {
                "X-eBirdApiToken": apiKey,
                },
            })
            .then(response => response.json())
            .then(data => {
                birdData = data
                if (data.length > 0) {
                    data.forEach(observation => {
                    var currDateParts = observation.obsDt.substring(0,10).split('-')
                    var currDate = Number(currDateParts[0]+currDateParts[1]+currDateParts[2])
                    observation.obsDt = currDate
                    L.circle([observation.lat, observation.lng], {
                        color: 'blue',
                        fillColor: 'blue',
                        fillOpacity: 0.7,
                        radius: 50000
                    }).addTo(layer);
                    L.marker([observation.lat, observation.lng]).addTo(fg)
                    })
                    layer.addTo(map)
                    map.fitBounds(fg.getBounds());

                    datesObjArr = []
                    dateArr = []

                    data.forEach(observation => {
                    dateObs.push(observation.obsDt)
                    });
                    dateSet = new Set(dateObs)
                    dateSet.forEach(date =>{
                    dateArr.push(date)
                    })
                    dateArr.sort()
                    //For each date it captures the bird data in the data object, then pushes those into a layer group

                    var d =0
                    dateArr.forEach(date => {
                    d=d+1
                    var dateObj = {
                        "id": d,
                        "dateInt": date,
                        "dateTxt": date.toString().slice(4,6)+"/"+date.toString().slice(6,8)+"/"+date.toString().slice(0,4)
                    }
                    datesObjArr.push(dateObj)

                    // birdByDay = birdData.filter(function (el) {
                    //   return el.obsDt === date
                    // });            
                    })
                    document.getElementById("dateRange").max = datesObjArr.length;
                    document.getElementById("dateRange").min = 1;
                    document.getElementById("dateRange").value = 30;
                    birdDate.textContent = "Not many on West Coast. Closest in last 30 Days";
                } else {
                    birdDate.textContent = "No birds reported in last 30 days";
                }
                
            })
        }


        var slider = document.getElementById("dateRange");
        slider.oninput = function() {
            layer.clearLayers()
            var tempDateInt
            var tempDateTxt
            datesObjArr.forEach(date => {
            if (slider.value == date.id){
                tempDateInt = date.dateInt
                tempDateTxt = date.dateTxt
            }
            })
            var bbd = birdData.filter(function (el){
            return el.obsDt <= tempDateInt
            })
            if(bbd.length > 0) {
                birdDate.textContent = tempDateTxt;
                bbd.forEach(observation => {
                    L.circle([observation.lat, observation.lng], {
                    color: 'red',
                    opacity: 0.1,
                    fillColor: '#f03',
                    fillOpacity: 0.3,
                    radius: 10000
                    }).addTo(layer);
                })
                layer.addTo(map)
            } 
        }
    </script>
  </body>
</html>
