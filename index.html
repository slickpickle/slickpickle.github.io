<!DOCTYPE html>
<html>
  <head>
    <title>Bird Migrations</title>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script><!-- jQuery base library needed -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script> 
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
    crossorigin=""/>

    <style>
        body{
                padding: 0;
                margin: 0;
        }
        .title {
            height: 5vh;
            text-align: center;
            text-align: center;
            font-family: -apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
            font-size: 1.5em;
            font-weight: 500;
            margin: 10px;
        }
        .slider {
            -webkit-appearance: none;
            width: 80%;
            margin-left: 10%;
            margin-top:20px;
            height: 15px;
            background: #EF4765;
            outline: none;
            border: 5px solid #FF9A5A;
            border-radius: 8px;
            opacity: 0.9;
            -webkit-transition: .2s;
            transition: opacity .2s;
          }
          .slider:hover {
            opacity: 1;
          }

          .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 40px;
            background: #EF4765;
            cursor: pointer;
            border: 5px solid #FF9A5A;
            border-radius: 4px;
          }
        @media (min-width: 767px) {
            .mobile {
                display: none;
            }

            #map {
                width: 70%;
                height: 100vh;
                float: left;
                border-radius: 12px;
                z-index: 1;
            }
            img {
            width: 300px;;
            }
            .legend {
                position: absolute;
                bottom: 0;
                left: 0;
                z-index: 9;
                margin-left: 20px;
                margin-bottom: 20px;
            }
            #selectors {
                width: 30%;
                height: 100vh;
                float: left;
            }
            select {
                width: 90%;
                margin-left: 5%;
                padding: 16px 20px;
                border: none;
                border-radius: 4px;
                background-color: #f1f1f1;
                margin-top:10px;
                font-family: -apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
                font-size: 24px;
                font-weight: 500;
            }
            .select2-selection {
                font-family: -apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
                font-size: 16px;
                font-weight: 500;
            }
            .select2-container {
                font-family: -apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
                font-size: 16px;
                font-weight: 500;
            }
            #dateContainer{
                text-align: center;
                font-family: -apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
                font-size: 12px;
                font-weight: 500;
            }
            #countContainer{
                text-align: center;
                font-family: -apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
                font-size: 12px;
                font-weight: 500;
            }
            .container{
                text-align: center;
                margin-bottom: 10px;
            }
        }
        @media (max-width: 766px) {
            .desktop {
                display: none;
            }
            .container {
                width: 50%;
                float: left;
                text-align: center;
            }
            #map {
                width: 100%;
                height: 60vh;
                float: left;
                border-radius: 12px;
                z-index: 1;
            }
            img {
            width: 200px;;
            }
            .legend {
                position: absolute;
                bottom: 0;
                left: 0;
                z-index: 9;
                margin-left: 5%;
                margin-bottom: 40%;
            }
            #selectors {
                width: 100%;
                height: 35%;
                float: left;
            }
            select {
                width: 95%;
                margin-left: 5%;
                padding: 16px 20px;
                border: none;
                border-radius: 4px;
                background-color: #f1f1f1;
                margin-top:10px;
            }
            #dateContainer{
                text-align: center;
                font-family: -apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
                font-size: 12px;
                font-weight: 500;
            }
            #countContainer{
                text-align: center;
                font-family: -apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
                font-size: 12px;
                font-weight: 500;
            }
        }

    </style>    
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM="
    crossorigin=""></script>

  </head>
  <body>
    <div class="title mobile">Migration Tracker</div>
    <div id="map"></div>
    <div class="legend"><img src="Legend.png" alt=""></div>   
    <div id = "selectors">
      <div class="title desktop">Migration Tracker</div>
      <div class="container">
        <select class="js-example-basic-single selectOld" id="notableList" name="notableList" style="width: 95%" onChange="mapBirds(this.value)">
            <option value="" disabled selected>Notable birds...</option>
        </select>
      </div>

      <div class="container">
        <select class="js-example-basic-single selectOld" id="oregonList" name="oregonList" style="width: 95%" onChange="mapBirds(this.value)">
            <option value="" disabled selected>Oregon birds...</option>
        </select>
      </div>
      <div class="sliderContainer">
            <input type="range" min="1" max="100" value="50" class="slider" id="dateRange">
      </div>
      <div id="dateContainer">
        <div id="date"></div>
      </div>
      <div id="countContainer">
        <div id="counts"></div>
      </div>
    </div>
    
    <script>

        $(document).ready(function() {
            $('.js-example-basic-single').select2();
        });

        var map = L.map('map').setView([40.8, -119.5], 4);
        L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}{r}.{ext}', {
            attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            subdomains: 'abcd',
            minZoom: 0,
            maxZoom: 20,
            ext: 'png'
        }).addTo(map);

        const apiKey = "g0gbj09j2s1b"; // replace with your own eBird API key      
        var enpointOregonRecent = "https://api.ebird.org/v2/data/obs/US-OR/recent"
        var enpointNotable = "https://api.ebird.org/v2/data/obs/US-OR/recent/notable?detail=simple"
        
        var notableData = []
        var uniqueNotable = []
        var oregonRecentData = []
        var uniqueOregon = []
        var fullList = []
        var birdData
        var layer = L.layerGroup()
        var dateObs = []
        var birdDate = document.getElementById("date");
        var siteCount
        var totalCount
        var symbology
        var first = {
            color: '#d97357',
            opacity: 0.1,
            fillColor: '#d97357',
            fillOpacity: 0.1,
            radius: 10000
        }
        var second = {
            color: '#cc8529',
            opacity: 0.1,
            fillColor: '#cc8529',
            fillOpacity: 0.2,
            radius: 10000
        }
        var third = {
            color: '#c4c41a',
            opacity: 0.0,
            fillColor: '#c4c41a',
            fillOpacity: 0.3,
            radius: 10000
        }
        var fourth = {
            color: '#4acc0e',
            opacity: 0.0,
            fillColor: '#4acc0e',
            fillOpacity: 0.3,
            radius: 10000
        }
        var firstFarAway = {
            color: '#d97357',
            opacity: 0.6,
            fillColor: '#d97357',
            fillOpacity: 0.3,
            radius: 50000
        }
        var secondFarAway = {
            color: '#cc8529',
            opacity: 0.6,
            fillColor: '#cc8529',
            fillOpacity: 0.3,
            radius: 50000
        }
        var thirdFarAway = {
            color: '#c4c41a',
            opacity: 0.6,
            fillColor: '#c4c41a',
            fillOpacity: 0.3,
            radius: 50000
        }
        var fourthFarAway = {
            color: '#4acc0e',
            opacity: 0.6,
            fillColor: '#4acc0e',
            fillOpacity: 0.3,
            radius: 50000
        }





        fetch(enpointOregonRecent, {
        headers: {
            "X-eBirdApiToken": apiKey,
            },
        })
        .then(response => response.json())
        .then(data => {
            data.forEach(observation => {
                var OrRecObj = {
                "comName": observation.comName,
                "speciesCode": observation.speciesCode
            }
            oregonRecentData.push(OrRecObj)
            fullList.push(OrRecObj) 
            });
            var uniqueOregon = [...new Set(oregonRecentData.map(item => item.comName))];
            uniqueOregon.sort();             

            var dataList = document.getElementById('oregonList'); 
            for(var i = 0; i < uniqueOregon.length; i++) {
            var opt = uniqueOregon[i];
            var el = document.createElement("option");
            el.text = opt;
            el.value = opt;
            dataList.appendChild(el);
            }
        })
            

        fetch(enpointNotable, {
            headers: {
            "X-eBirdApiToken": apiKey,
            },
        })
        .then(response => response.json())
        .then(data => {
            data.forEach(observation => {
            var notableObj = {
                "comName": observation.comName,
                "speciesCode": observation.speciesCode
            }
            notableData.push(notableObj)
            fullList.push(notableObj) 
            });
            var uniqueNotable = [...new Set(notableData.map(item => item.comName))];
            uniqueNotable.sort();             

            var dataList = document.getElementById('notableList'); 
            for(var i = 0; i < uniqueNotable.length; i++) {
            var opt = uniqueNotable[i];
            var el = document.createElement("option");
            el.text = opt;
            el.value = opt;
            dataList.appendChild(el);
            }
        })



        function mapBirds(comName) {

            siteCount = 0
            totalCount = 0
            birdDate.textContent = "Last 30 Days";
            var fg = L.featureGroup();
            var specCode
            fullList.forEach(type => {
            if (comName == type.comName) {
                specCode = type.speciesCode
            }
            })
            fetch(`https://api.ebird.org/v2/data/obs/US-OR/recent/${specCode}?back=30&r=US-ID,US-CA,US-NV,US-WA,US-OR`, {
            headers: {
            "X-eBirdApiToken": apiKey,
            },
            })
            .then(response => response.json())
            .then(data => {
                data.sort((a, b) => a.obsDt.localeCompare(b.obsDt));
                birdData = data
                layer.clearLayers()
                data.forEach(observation => {
                    if (observation.howMany) {
                        totalCount = totalCount + observation.howMany
                    }
                    siteCount = siteCount + 1
                    var currDateParts = observation.obsDt.substring(0,10).split('-')
                    var currDate = Number(currDateParts[0]+currDateParts[1]+currDateParts[2])
                    observation.obsDt = currDate
                });

                if (data.length > 1) {   
                                 
                    data.forEach(observation => {
                        dateObs.push(observation.obsDt)
                    })

                    datesObjArr = []
                    dateArr = []
                    dateSet = new Set(dateObs)

                    dateSet.forEach(date =>{
                        dateArr.push(date)
                    })

                    dateArr.sort()

                    var d =0

                    dateArr.forEach(date => {
                        d=d+1
                        var dateObj = {
                            "id": d,
                            "dateInt": date,
                            "dateTxt": date.toString().slice(4,6)+"/"+date.toString().slice(6,8)+"/"+date.toString().slice(0,4)
                        }
                        datesObjArr.push(dateObj)
          
                    })
                    
                    var monthQuarters = Math.max(...datesObjArr.map(o => o.id))/4

                    data.forEach(observation => {
                        var dtObj = datesObjArr.filter(function (el) {
                            return el.dateInt == observation.obsDt
                        });

                        observation.dateIndex = dtObj[0].id

                        if (observation.dateIndex < monthQuarters) {
                            symbology = first
                        } else if (observation.dateIndex >= monthQuarters && observation.dateIndex < monthQuarters*2) {
                            symbology = second
                        } else if (observation.dateIndex >= monthQuarters*2 && observation.dateIndex < monthQuarters*3) {
                            symbology = third
                        } else {
                            symbology = fourth
                        }

                        L.circle([observation.lat, observation.lng], symbology).bindPopup("Date: "+observation.obsDt.toString().slice(4,6)+"/"+observation.obsDt.toString().slice(6,8)+"/"+observation.obsDt.toString().slice(0,4)+`</br>Location: `+observation.locName+`</br>Bird Info: <a target='_blank' href='https://ebird.org/species/${specCode}'>More Info</a>`).addTo(layer);
                        L.marker([observation.lat, observation.lng]).addTo(fg)
                    })
                    layer.addTo(map)
                    map.fitBounds(fg.getBounds());

                    document.getElementById("dateRange").max = datesObjArr.length;
                    document.getElementById("dateRange").min = 1;
                    document.getElementById("dateRange").value = 30;
                    document.getElementById("counts").textContent = `Site Count: ${siteCount.toLocaleString()} | Total Count: ${totalCount.toLocaleString()}`
                } else {
                    farAwayMap(specCode)
                }

            })

        }

        function farAwayMap(speciesCode) {
            siteCount = 0
            totalCount = 0
            var fg = L.featureGroup();
            fetch(`https://api.ebird.org/v2/data/nearest/geo/recent/${speciesCode}?lat=44.3&lng=-121.2&back=30`, {
            headers: {
                "X-eBirdApiToken": apiKey,
                },
            })
            .then(response => response.json())
            .then(data => {
                birdData = data
                if (data.length > 0) {

                    data.sort((a, b) => a.obsDt.localeCompare(b.obsDt));
                    layer.clearLayers()
                    data.forEach(observation => {
                        if (observation.howMany) {
                            totalCount = totalCount + observation.howMany
                        }
                        siteCount = siteCount + 1
                        var currDateParts = observation.obsDt.substring(0,10).split('-')
                        var currDate = Number(currDateParts[0]+currDateParts[1]+currDateParts[2])
                        observation.obsDt = currDate
                    }); 
                                
                    data.forEach(observation => {
                        dateObs.push(observation.obsDt)
                    })

                    datesObjArr = []
                    dateArr = []
                    dateSet = new Set(dateObs)

                    dateSet.forEach(date =>{
                        dateArr.push(date)
                    })

                    dateArr.sort()

                    var d =0

                    dateArr.forEach(date => {
                        d=d+1
                        var dateObj = {
                            "id": d,
                            "dateInt": date,
                            "dateTxt": date.toString().slice(4,6)+"/"+date.toString().slice(6,8)+"/"+date.toString().slice(0,4)
                        }
                        datesObjArr.push(dateObj)
        
                    })
                    
                    var monthQuarters = Math.max(...datesObjArr.map(o => o.id))/4

                    data.forEach(observation => {
                        var dtObj = datesObjArr.filter(function (el) {
                            return el.dateInt == observation.obsDt
                        });

                        observation.dateIndex = dtObj[0].id

                        if (observation.dateIndex < monthQuarters) {
                            symbology = firstFarAway
                        } else if (observation.dateIndex >= monthQuarters && observation.dateIndex < monthQuarters*2) {
                            symbology = secondFarAway
                        } else if (observation.dateIndex >= monthQuarters*2 && observation.dateIndex < monthQuarters*3) {
                            symbology = thirdFarAway
                        } else {
                            symbology = fourthFarAway
                        }

                        L.circle([observation.lat, observation.lng], symbology).bindPopup("Date: "+observation.obsDt.toString().slice(4,6)+"/"+observation.obsDt.toString().slice(6,8)+"/"+observation.obsDt.toString().slice(0,4)+`</br>Location: `+observation.locName+`</br>Bird Info: <a target='_blank' href='https://ebird.org/species/${speciesCode}'>More Info</a>`).addTo(layer);
                        L.marker([observation.lat, observation.lng]).addTo(fg)
                    })
                    layer.addTo(map)
                    map.fitBounds(fg.getBounds());

 

                    document.getElementById("dateRange").max = datesObjArr.length;
                    document.getElementById("dateRange").min = 1;
                    document.getElementById("dateRange").value = 30;
                    birdDate.textContent = "Not many on West Coast. Closest in last 30 Days";
                    document.getElementById("counts").textContent = `Site Count: ${siteCount.toLocaleString()} | Total Count: ${totalCount.toLocaleString()}`
                } else {
                    birdDate.textContent = "No birds reported in last 30 days";
                    document.getElementById("counts").textContent = ''
                }
                
            })
        }


        var slider = document.getElementById("dateRange");
        slider.oninput = function() {
            layer.clearLayers()
            var tempDateInt
            var tempDateTxt
            datesObjArr.forEach(date => {
            if (slider.value == date.id){
                tempDateInt = date.dateInt
                tempDateTxt = date.dateTxt
            }
            })
            var bbd = birdData.filter(function (el){
            return el.obsDt <= tempDateInt
            })
            if(bbd.length > 0) {
                var monthQuarters = Math.max(...datesObjArr.map(o => o.id))/4
                birdDate.textContent = tempDateTxt;

                bbd.forEach(observation => {
                    if (observation.dateIndex < monthQuarters) {
                        symbology = first
                    } else if (observation.dateIndex >= monthQuarters && observation.dateIndex < monthQuarters*2) {
                        symbology = second
                    } else if (observation.dateIndex >= monthQuarters*2 && observation.dateIndex < monthQuarters*3) {
                        symbology = third
                    } else {
                        symbology = fourth
                    }
                    L.circle([observation.lat, observation.lng], symbology).bindPopup("Date: "+observation.obsDt.toString().slice(4,6)+"/"+observation.obsDt.toString().slice(6,8)+"/"+observation.obsDt.toString().slice(0,4)+`</br>Location: `+observation.locName+`</br>Bird Info: <a target='_blank' href='https://ebird.org/species/${observation.speciesCode}'>More Info</a>`).addTo(layer);

                })
                layer.addTo(map)
            } 
        }
    </script>
  </body>
</html>
